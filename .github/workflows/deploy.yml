name: Deploy Flink Application

# 核心触发器：监听来自外部仓库的 dispatch 事件
on:
#   repository_dispatch:
#     # 只响应事件类型为 'flink-deploy' 的触发
#     types: [flink-deploy]

  schedule:
    # 每天 UTC 5:00 (东八区时间 13:00) 自动触发 dev 环境部署
    - cron: '0 5 * * *'

  # 触发器 2: 允许在 GitHub UI 上手动触发此 workflow
  workflow_dispatch:
    inputs:
      # 我们在这里定义手动触发时需要输入的参数
      # 这些参数的名字和默认值都来自于你提供的上游 dispatch log
      # image_uri:
      #   description: '【用于测试】要部署的完整 Docker 镜像 URI'
      #   required: true
      #   default: '461636397270.dkr.ecr.us-east-1.amazonaws.com/ingestion_kafka_flink:latest'
      #   type: string
      environment:
        description: '要部署的目标环境 (dev 或 prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
#       ref:
#         description: '【用于测试】来源分支 (例如 develop)'
#         required: false
#         default: 'develop'
#         type: string
#       sha:
#         description: '【用于测试】来源 Commit SHA (用于追溯)'
#         required: false
#         default: 'c073ede61bd92b16c18272398d0b66cc0263b87f'
#         type: string

jobs:
  #====================================================
  #==             部署到开发环境 (Dev)             ==
  #==         一个 Job 完成所有自动化操作            ==
  #====================================================
  deploy-dev:
    # 条件：仅当触发事件中的环境字段为 'dev' 时运行
    # if: >-
    #   (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev') ||
    #   (github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'dev')
    # if: github.event.inputs.environment == 'dev'
    if: >-
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev') ||
      (github.event_name == 'schedule' || github.event.inputs.environment == 'dev')

    runs-on: self-hosted
    environment: dev # 关联到名为 'dev' 的 GitHub Environment
    permissions:
      id-token: write   # OIDC 权限
      contents: read    # 拉取代码权限

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_AWS_ROLE_ARN }} # 使用 Dev 环境的 IAM Role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --- 新增的调试步骤 ---
      - name: List files for debugging
        # 确保工作目录和你 Terraform 的一致！
        working-directory: ./environments/dev # <-- ‼️ 替换成你的真实路径
        run: |
          echo "--- Listing all files recursively ---"
          ls -R
          echo "--- Checking content of terraform.tfvars ---"
          # 如果文件存在，就打印它的内容；如果不存在，就报告错误
          cat terraform.tfvars || echo "!!! terraform.tfvars NOT FOUND !!!"
      # --- 调试步骤结束 ---

      - name: Terraform Init, Validate & Fmt
        working-directory: ./environments/dev
        run: |
          terraform init
          terraform validate
          terraform fmt -check

      - name: Terraform Plan & Apply (Dev)
        working-directory: ./environments/dev
#         env:
#           # 使用三元表达式智能判断数据来源，并将其设置为 Terraform 变量
#           # Terraform 会自动识别以 TF_VAR_ 开头的环境变量
#           TF_VAR_flink_image_uri: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.image_uri || github.event.client_payload.image_uri }}
        run: |
          # 在 Dev 环境，直接 Plan 并自动 Apply,无需再写 -var 参数
          terraform plan -target="module.ingestion"
          terraform apply -auto-approve -target="module.ingestion"